<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Visor Multi-CSV con Exportación a Excel</title>
<style>
body { font-family: Arial, sans-serif; background: #0D3B66; color: #FAF0CA; padding: 20px; }
h2 { margin-bottom: 12px; }
input, button { padding: 6px; border-radius: 6px; border: 1px solid #FAF0CA; background: #1a1f36; color: #FAF0CA; margin-top: 4px; }
table { border-collapse: collapse; width: 100%; margin-top: 12px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: right; }
th:first-child, td:first-child { text-align: left; }
th { background: #0D3B66; color: #FAF0CA; }
tr:hover { background: #1a1f36; }
button { cursor:pointer; background:#0D3B66; color:#FAF0CA; border:none; margin-top:6px; }
button:hover:not(:disabled) { background:#081a3f; }
button:disabled { opacity:0.5; cursor:not-allowed; }
.paging-controls { margin-top: 10px; display:flex; align-items:center; gap:10px; }
</style>
</head>
<body>

<h2>Visor Multi-CSV</h2>

<input type="file" id="csvFile" accept=".csv" multiple>

<div class="controls">
  <label>Fecha inicio:<input type="date" id="startDate"></label>
  <label>Fecha fin:<input type="date" id="endDate"></label>
  <label>Pileta:<input type="number" id="piletaSelector" placeholder="Dejar vacío para todas"></label>
  <label><input type="checkbox" id="sumMode"> Sumar piletas</label>
  <label>Líneas por página:<input type="number" id="rowsPerPage" min="1" value="20"></label>
  <button id="applyFilter">Aplicar filtro</button>
  <button id="exportExcel" style="display:none;">Exportar a Excel</button>
  <div class="paging-controls">
    <button id="prevPage" disabled>Anterior</button>
    <span id="pageInfo"></span>
    <button id="nextPage" disabled>Siguiente</button>
  </div>
</div>

<table id="output"></table>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
let headers=[], originalRows=[], filteredData=[], currentPage=1, totalPages=1;

document.getElementById("csvFile").addEventListener("change", e=>{
  const files=[...e.target.files]; 
  if(!files.length) return;
  originalRows=[]; headers=[];
  let allData=[], filesRead=0;

  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      const lines=ev.target.result.split(/\r?\n/).filter(l=>l.trim());
      const rows=lines.map(l=>l.split(",").map(v=>v.trim()));
      allData.push(rows); filesRead++;
      if(filesRead===files.length) mergeData(allData);
    };
    reader.readAsText(file);
  });
});

function mergeData(dataList){
  const allHeaders=new Set();
  dataList.forEach(rows=>rows[0].forEach(h=>allHeaders.add(h.trim())));
  headers=[...allHeaders];
  const merged=[];
  dataList.forEach(rows=>{
    const map=rows[0].map(h=>headers.indexOf(h.trim()));
    for(let i=1;i<rows.length;i++){
      const r=new Array(headers.length).fill("");
      rows[i].forEach((v,idx)=>{ 
        if(map[idx]>=0) r[map[idx]]=v.trim(); 
      });
      merged.push(r);
    }
  });
  originalRows=[headers,...merged];
  renderTable(originalRows);
}

document.getElementById("applyFilter").addEventListener("click",applyFilters);
document.getElementById("prevPage").addEventListener("click",()=>{ if(currentPage>1){currentPage--; renderPage(); }});
document.getElementById("nextPage").addEventListener("click",()=>{ if(currentPage<totalPages){currentPage++; renderPage(); }});

function applyFilters(){
  if(!originalRows.length) return;
  currentPage=1;
  const start=document.getElementById("startDate").value;
  const end=document.getElementById("endDate").value;
  const pileta=document.getElementById("piletaSelector").value;

  const idxDate=headers.findIndex(h=>h.toLowerCase().includes("date")||h.toLowerCase().includes("fecha"));
  const idxTime=headers.findIndex(h=>h.toLowerCase().includes("hora")||h.toLowerCase().includes("time"));
  const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));

  filteredData=originalRows.slice(1).filter(r=>{
    if(idxDate>=0 && start && new Date(r[idxDate])<new Date(start)) return false;
    if(idxDate>=0 && end && new Date(r[idxDate])>new Date(end)) return false;
    if(pileta && idxPileta>=0 && r[idxPileta]!==pileta) return false;
    return true;
  });

  // Sorting
  const sumMode=document.getElementById("sumMode").checked;
  if(sumMode){
    filteredData.sort((a,b)=>{
      const aNum=parseInt(a[idxPileta])||0;
      const bNum=parseInt(b[idxPileta])||0;
      return aNum-bNum;
    });
  } else if(idxDate>=0){
    filteredData.sort((a,b)=>{
      const dateA=new Date(a[idxDate]+" "+(idxTime>=0?a[idxTime]:"00:00:00"));
      const dateB=new Date(b[idxDate]+" "+(idxTime>=0?b[idxTime]:"00:00:00"));
      return dateA-dateB;
    });
  }

  updatePagination();
  document.getElementById("exportExcel").style.display="inline-block";
  renderPage();
}

function updatePagination(){
  totalPages=Math.ceil(filteredData.length/parseInt(document.getElementById("rowsPerPage").value));
}

function formatInt(n){ return !isNaN(n)?parseInt(n).toLocaleString("es-ES"):""; }
function formatDec(n){ return !isNaN(n)?parseFloat(n).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}):""; }

function renderPage(){
  const sumMode=document.getElementById("sumMode").checked;
  const rowsPerPage=parseInt(document.getElementById("rowsPerPage").value);
  const pageData=sumMode?filteredData:filteredData.slice((currentPage-1)*rowsPerPage,(currentPage-1)*rowsPerPage+rowsPerPage);

  if(sumMode){
    const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));
    const idxPeso=headers.findIndex(h=>h.toLowerCase()==="peso");
    const idxDesc=headers.findIndex(h=>h.toLowerCase()==="racao_decarregad");

    const table=[["Pileta","Peso esperado","Peso descargado"]];
    const group={};
    filteredData.forEach(r=>{
      const p=r[idxPileta];
      if(!group[p]) group[p]={peso:0,desc:0};
      group[p].peso+=parseFloat(r[idxPeso]||0);
      group[p].desc+=parseFloat(r[idxDesc]||0);
    });
    Object.keys(group).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{
      table.push([p,formatInt(group[p].peso),formatDec(group[p].desc)]);
    });
    renderTable(table);
  } else {
    const idxDate=headers.findIndex(h=>h.toLowerCase().includes("date")||h.toLowerCase().includes("fecha"));
    const idxTime=headers.findIndex(h=>h.toLowerCase().includes("hora")||h.toLowerCase().includes("time"));
    const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));
    const idxDens=headers.findIndex(h=>h.toLowerCase()==="peso_esp_racao");
    const idxPeso=headers.findIndex(h=>h.toLowerCase()==="peso");
    const idxDesc=headers.findIndex(h=>h.toLowerCase()==="racao_decarregad");

    const table=[["Fecha","Hora","Pileta","Densidad (Gr/Lts)","Peso esperado","Peso descargado"]];
    pageData.forEach(r=>{
      table.push([
        idxDate>=0?r[idxDate]:"",
        idxTime>=0?r[idxTime]:"",
        formatInt(r[idxPileta]),
        formatInt(r[idxDens]),
        formatInt(r[idxPeso]),
        formatDec(r[idxDesc])
      ]);
    });
    renderTable(table);
    document.getElementById("pageInfo").textContent=`Página ${currentPage} de ${totalPages}`;
    document.getElementById("prevPage").disabled=currentPage<=1;
    document.getElementById("nextPage").disabled=currentPage>=totalPages;
  }
}

document.getElementById("exportExcel").addEventListener("click",()=>{
  const sumMode=document.getElementById("sumMode").checked;
  const start=document.getElementById("startDate").value;
  const end=document.getElementById("endDate").value;
  const ws_data=[];
  if(sumMode){
    const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));
    const idxPeso=headers.findIndex(h=>h.toLowerCase()==="peso");
    const idxDesc=headers.findIndex(h=>h.toLowerCase()==="racao_decarregad");
    const group={};
    filteredData.forEach(r=>{
      const p=r[idxPileta]; if(!group[p]) group[p]={peso:0,desc:0};
      group[p].peso+=parseFloat(r[idxPeso]||0);
      group[p].desc+=parseFloat(r[idxDesc]||0);
    });
    ws_data.push([`Fecha: ${start||"Inicio"} - ${end||"Fin"}`,"",""]); // merged row
    ws_data.push(["Pileta","Peso esperado","Peso descargado"]);
    Object.keys(group).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{
      ws_data.push([p,group[p].peso,group[p].desc]);
    });
  } else {
    const idxDate=headers.findIndex(h=>h.toLowerCase().includes("date")||h.toLowerCase().includes("fecha"));
    const idxTime=headers.findIndex(h=>h.toLowerCase().includes("hora")||h.toLowerCase().includes("time"));
    const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));
    const idxDens=headers.findIndex(h=>h.toLowerCase()==="peso_esp_racao");
    const idxPeso=headers.findIndex(h=>h.toLowerCase()==="peso");
    const idxDesc=headers.findIndex(h=>h.toLowerCase()==="racao_decarregad");

    ws_data.push(["Fecha","Hora","Pileta","Densidad (Gr/Lts)","Peso esperado","Peso descargado"]);
    filteredData.forEach(r=>{
      ws_data.push([
        idxDate>=0?r[idxDate]:"",
        idxTime>=0?r[idxTime]:"",
        r[idxPileta], r[idxDens], r[idxPeso], r[idxDesc]
      ]);
    });
  }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);

  // Merge A1:C1 if sumar piletas
  if(sumMode) ws["!merges"]=[{s:{r:0,c:0}, e:{r:0,c:2}}];

  XLSX.utils.book_append_sheet(wb, ws, "Tabla");
  XLSX.writeFile(wb, "tabla.xlsx");
});

function renderTable(rows){
  const table=document.getElementById("output"); table.innerHTML="";
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    r.forEach(c=>{
      const td=document.createElement(i===0?"th":"td");
      td.textContent=c;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}
</script>

</body>
</html>
